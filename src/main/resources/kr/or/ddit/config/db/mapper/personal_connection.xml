<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="personal">


	<!-- 일촌 리스트 조회 -->
	<select id="select_connections" parameterType="memberVo" resultType="usersVo">
		select a.user_id,
	           users.profile_path,
	           users.user_name,
	           users.profile_img,
	           b.introduce
       
		  from users ,( select user_id
		                  from personal_connection
		                 where (user_id =#{mem_id} or receive_id =#{mem_id})
		                   and receive_accept='Y'
		                   and user_id !=#{mem_id}
		                 union
		                select receive_id
		                  from personal_connection
		                 where (user_id =#{mem_id} or receive_id =#{mem_id})
		                   and receive_accept='Y'
		                   and receive_id !=#{mem_id}) a , (select user_id,   
                                                                       substr(listagg(beintroduce, ' ') within group (order by graduation desc), 0, instr(listagg(beintroduce, ' ') within group (order by graduation desc), ' ', 1, 2)) as introduce
                                                                           
                                                                  from (select a.user_id,
	                                                                      case when b.resign_date is null then b.corporate_name ||' ' ||job_position || ' '
	                                                                           when b.resign_date is not null then a.school_name ||' ' || a.degree_name || ' '
	                                                                       end as beintroduce,
	                                                                           a.graduation
	                                                                      from education_info a, career_info b
	                                                                     where a.user_id = b.user_id
	                                                                       and (b.user_id,nvl(b.resign_date,to_date('3000/01/01','yyyy/mm/dd'))) in ( select career_info.user_id,  max(nvl(career_info.resign_date,to_date('3000/01/01','yyyy/mm/dd')))
	                                                                                                                                                    from career_info, education_info
	                                                                                                                                                   where career_info.user_id = education_info.user_id
	                                                                                                                                                   group by career_info.user_id)
	                                                                     order by a.graduation desc)
	                                                             group by user_id ) b
		 where a.user_id = b.user_id(+)
		   and a.user_id = users.user_id(+)
	</select>
	
	
	<!-- 팔로우한 일촌 수 조회 -->
	<select id="connections_count" parameterType="memberVo" resultType="int">
		select
			count(*)
		from
			personal_connection
		where
			(user_id=#{mem_id} or receive_id=#{mem_id})
		and
			receive_accept='Y'
	</select>
	
	
	<!-- 팔로우한 회사 수 조회 -->
	<select id="coporations_count" parameterType="followVo" resultType="int">
		select
			count(*)
		 from
		 	follow
		where
			division='11'
		  and
		  	mem_id=#{mem_id}
	</select>
	
	
	<!-- 팔로우한 회사 리스트 조회 -->
	<select id="select_followCoporation" parameterType="followVo" resultType="corporationVo">
		select
			b.*,
			a.follow_code
  		from
  			follow a, corporation b
 		where
 			a.mem_id=#{mem_id}
   		and
   			a.division=#{division}
   		and
   			a.ref_keyword = b.corp_id
	</select>
	
	<!-- 팔로우한 일촌 리스트 조회 -->
	<select id="select_followConnections" parameterType="memberVo" resultType="usersVo">
		select a.user_id,
               users.profile_path,
               users.user_name,
               users.profile_img,
               b.introduce,
               a.follow_code
          from users ,( select a.user_id,b.follow_code
                          from (select user_id
                                  from personal_connection
                                 where (user_id =#{mem_id} or receive_id =#{mem_id})
                                   and receive_accept='Y'
                                   and user_id !=#{mem_id}
                                 union
                                select receive_id
                                  from personal_connection
                                 where (user_id =#{mem_id} or receive_id =#{mem_id})
                                   and receive_accept='Y'
                                   and receive_id !=#{mem_id}) a,(select follow_code,
                                                                         mem_id,
                                                                         ref_keyword,
                                                                         division
                                                                    from follow
                                                                   where division='43' 
                                                                     and mem_id=#{mem_id})b 
                         where a.user_id = b.REF_KEYWORD) a , ( select distinct(a.user_id),
                                                                            case when b.resign_date is null then b.corporate_name || ' ' ||  job_position
                                                                                 when b.resign_date is not null then a.school_name ||  ' ' || a.degree_name
                                                                             end as introduce
                                                                            from EDUCATION_INFO a, CAREER_INFO b
                                                                           where a.user_id = b.user_id
                                                                             and (b.user_id,nvl(b.resign_date,to_date('3000/01/01','yyyy/mm/dd'))) in ( select CAREER_INFO.user_id,  max(nvl(CAREER_INFO.resign_date,to_date('3000/01/01','yyyy/mm/dd')))
                                                                                                                                                          from CAREER_INFO, EDUCATION_INFO
                                                                                                                                                         where CAREER_INFO.user_id = education_info.user_id
                                                                                                                                                      group by CAREER_INFO.user_id)) b
		 where a.user_id = b.user_id(+)
		   and a.user_id = users.user_id(+)
	</select>
	
	
	<!-- 팔로우한 해시태그 리스트 조회 -->
	<select id="select_followHashTag" parameterType="memberVo" resultType="followVo">
		select
			FOLLOW_CODE,
			MEM_ID,
			REF_KEYWORD,
			DIVISION
		from
			FOLLOW
		where
			division='16'
		and
			mem_id=#{mem_id}
	</select>
	
	
	<!-- 받은 일촌 신청 리스트 조회 -->
	<select id="select_connectionReceiveList" parameterType="String" resultType="usersVo">
		select a.user_id,
               users.profile_path,
               users.user_name,
               users.profile_img,
               b.introduce
          from users ,(select user_id
                         from personal_connection
                        where receive_id = #{receive_id}
                          and receive_accept='N' ) a , (select user_id,   
                                                                       substr(listagg(beintroduce, ' ') within group (order by graduation desc), 0, instr(listagg(beintroduce, ' ') within group (order by graduation desc), ' ', 1, 2)) as introduce
                                                                           
                                                                  from (select a.user_id,
	                                                                      case when b.resign_date is null then b.corporate_name ||' ' ||job_position || ' '
	                                                                           when b.resign_date is not null then a.school_name ||' ' || a.degree_name || ' '
	                                                                       end as beintroduce,
	                                                                           a.graduation
	                                                                      from education_info a, career_info b
	                                                                     where a.user_id = b.user_id
	                                                                       and (b.user_id,nvl(b.resign_date,to_date('3000/01/01','yyyy/mm/dd'))) in ( select career_info.user_id,  max(nvl(career_info.resign_date,to_date('3000/01/01','yyyy/mm/dd')))
	                                                                                                                                                    from career_info, education_info
	                                                                                                                                                   where career_info.user_id = education_info.user_id
	                                                                                                                                                   group by career_info.user_id)
	                                                                     order by a.graduation desc)
	                                                             group by user_id ) b
		 where a.user_id = b.user_id(+)
		   and a.user_id = users.user_id(+) 
	</select>
	
	
	<!-- 보낸 일촌 신청 리스트 조회 -->
	<select id="select_connectionSendList" parameterType="String" resultType="usersVo">
		select a.receive_id as user_id,
               users.profile_path,
               users.user_name,
               users.profile_img,
               users.addr1,
               b.introduce
          from users ,(select receive_id
						 from personal_connection 
						where user_id=#{user_id}
						  and receive_accept='N' ) a , (select user_id,   
                                                                       substr(listagg(beintroduce, ' ') within group (order by graduation desc), 0, instr(listagg(beintroduce, ' ') within group (order by graduation desc), ' ', 1, 2)) as introduce
                                                                           
                                                                  from (select a.user_id,
	                                                                      case when b.resign_date is null then b.corporate_name ||' ' ||job_position || ' '
	                                                                           when b.resign_date is not null then a.school_name ||' ' || a.degree_name || ' '
	                                                                       end as beintroduce,
	                                                                           a.graduation
	                                                                      from education_info a, career_info b
	                                                                     where a.user_id = b.user_id
	                                                                       and (b.user_id,nvl(b.resign_date,to_date('3000/01/01','yyyy/mm/dd'))) in ( select career_info.user_id,  max(nvl(career_info.resign_date,to_date('3000/01/01','yyyy/mm/dd')))
	                                                                                                                                                    from career_info, education_info
	                                                                                                                                                   where career_info.user_id = education_info.user_id
	                                                                                                                                                   group by career_info.user_id)
	                                                                     order by a.graduation desc)
	                                                             group by user_id ) b
		 where a.RECEIVE_ID = b.user_id(+)
		   and a.RECEIVE_ID = users.user_id(+)
	</select>
	
	
	<!-- 받은 일촌 신청 수락 -->
	<update id="update_connectionReceiveApply" parameterType="personalVo">
		update
			personal_connection
		set
			receive_accept='Y'
		where
			receive_id=#{receive_id}
		and
			user_id=#{user_id}
		and
			receive_accept='N'
	</update>
	
	
	<!-- 받은/보낸 일촌 신청 거절(취소) -->
	<delete id="delete_connectionCancel" parameterType="personalVo">
		delete
		from
			personal_connection
		where
			user_id=#{user_id}
		and  
			receive_id=#{receive_id}
		and
			receive_accept='N'
	</delete>
	
	
	<!-- 전체(회사,해시태그,인맥,인맥밖) 팔로우한 수 조회 -->
	<select id="allFollowCnt" parameterType="followVo" resultType="int">
		select
			count(*)
		from
			follow
		where
			mem_id=#{mem_id}
	</select>
	
	
	<!-- 아는 동문 찾기 -->
	<select id="schoolFriendsSearch" parameterType="String" resultType="usersVo">
		select distinct(a.user_id) as user_id,
		               users.profile_path,
		               users.user_name,
		               users.profile_img,
		               b.introduce
          from users ,( select a.user_id , b.school_name
			              from education_info a,  (select a.*
                                                     from (select school_name
                                                             from education_info
                                                            where user_id=#{user_id}
                                                            order by graduation desc) a) b
			             where a.school_name = b.school_name
                         group by a.user_id,b.school_name) a , (select user_id,   
                                                                       substr(listagg(beintroduce, ' ') within group (order by graduation desc), 0, instr(listagg(beintroduce, ' ') within group (order by graduation desc), ' ', 1, 2)) as introduce
                                                                           
                                                                  from (select a.user_id,
	                                                                      case when b.resign_date is null then b.corporate_name ||' ' ||job_position || ' '
	                                                                           when b.resign_date is not null then a.school_name ||' ' || a.degree_name || ' '
	                                                                       end as beintroduce,
	                                                                           a.graduation
	                                                                      from education_info a, career_info b
	                                                                     where a.user_id = b.user_id
	                                                                       and (b.user_id,nvl(b.resign_date,to_date('3000/01/01','yyyy/mm/dd'))) in ( select career_info.user_id,  max(nvl(career_info.resign_date,to_date('3000/01/01','yyyy/mm/dd')))
	                                                                                                                                                    from career_info, education_info
	                                                                                                                                                   where career_info.user_id = education_info.user_id
	                                                                                                                                                   group by career_info.user_id)
	                                                                     order by a.graduation desc)
	                                                             group by user_id ) b
		 where a.user_id = b.user_id(+)
		   and a.user_id = users.user_id(+)
           and a.user_id not in ( select receive_id
                                     from personal_connection
                                    where user_id = #{user_id} )
           and a.user_id != #{user_id}
	</select>
	
	
	<!-- 인맥 - 회사 - 신선한 시각 필로우에 출력되는 회사 -->
	<select id="feedFollowCorporation" parameterType="String" resultType="corporationVo">
	select
		a.*
    from
    	corporation a
    where not
    	a.corp_id in (select ref_keyword
                        from follow
                       where mem_id=#{mem_id}
                         and division='11')
	</select>
	
	
	<!-- 인맥 - 회사 - 신선한 시각 필로우에 출력되는 유저 -->
	<select id="feedFollowUser" parameterType="String" resultType="usersVo">
		select users.* , b.introduce
		  from users ,( select introduce , user_id
		                  from (select distinct(a.user_id),
		                          case when b.resign_date is null then b.corporate_name || ' ' || job_position
		                               when b.resign_date is not null then  a.school_name || ' ' || a.degree_name
		                           end as introduce
		                          from education_info a, career_info b
		                         where a.user_id = b.user_id
		                           and (b.user_id,nvl(b.resign_date,to_date('3000/01/01','yyyy/mm/dd'))) in ( select career_info.user_id,  max(nvl(career_info.resign_date,to_date('3000/01/01','yyyy/mm/dd')))
		                                                                                                        from career_info, education_info
		                                                                                                       where career_info.user_id = education_info.user_id
		                                                                                                       group by career_info.user_id) ))b           
		 where not users.user_id in (select ref_keyword
	                                   from follow
	                                  where mem_id=#{mem_id}
	                                    and division='43')
		   and users.user_id !=#{mem_id}
		   and users.user_id = b.user_id(+)
	</select>
	
	
	<!-- 인맥 - 회사 - 신선한 시각 필로우에 출력되는 해시태그 -->
	<select id="feedFollowHashTag" parameterType="String" resultType="hashtagVo">
		select
			a.*
     	from
     		hashtag a
     	where not
     		a.hashtag_name in (select ref_keyword
                           		 from follow
                           		where mem_id=#{mem_id}
                           		  and division='16')
	</select>
	
	
	<!-- 회원님을 위한 맞춤 추천 - 사람(users) -->
	<select id="recommendUsers" parameterType="paginationVo" resultType="usersVo">
		select *
        from
              (select a.*, rownum rn
from (select distinct(a.user_id) as user_id,
               users.profile_path,
               users.user_name,
               users.profile_img,
               b.introduce
          from users ,( select a.user_id
                    from users a   
                   where a.user_id != #{user_id}
                     and not a.user_id in ( select ref_keyword
                                              from follow
                                             where mem_id = #{user_id}
                                               and division = '43')) a , ( select user_id,   
                                                                                substr(listagg(beintroduce, ' ') within group (order by graduation desc), 0, instr(listagg(beintroduce, ' ') within group (order by graduation desc), ' ', 1, 2)) as introduce
                                                                             from 
                                                                          (select a.user_id,
                                                                             case when b.resign_date is null then b.corporate_name ||' ' ||job_position || ' '
                                                                                  when b.resign_date is not null then a.school_name ||' ' || a.degree_name || ' '
                                                                              end as beintroduce,
                                                                              a.graduation
                                                                             from education_info a, career_info b
                                                                            where a.user_id = b.user_id
                                                                              and (b.user_id,nvl(b.resign_date,to_date('3000/01/01','yyyy/mm/dd'))) in ( select career_info.user_id,  max(nvl(career_info.resign_date,to_date('3000/01/01','yyyy/mm/dd')))
                                                                                                                                                           from career_info, education_info
                                                                                                                                                          where career_info.user_id = education_info.user_id
                                                                                                                                                       group by career_info.user_id)
                                                                             order by a.graduation desc)
                                                                            group by user_id ) b
            where a.user_id = b.user_id(+)
            and a.user_id = users.user_id(+)
            and a.user_id not in ( select receive_id
                                     from personal_connection
                                    where user_id = #{user_id}))a)a
                  
                  
where rn between (#{page} -1) * #{pageSize} + 1 and #{page} * #{pageSize}
	</select>
	
	
	<!-- 필터로 검색 - 지역 검색 -->
	<select id="filterSearchLocal" parameterType="String" resultType="usersVo">
		select substr(addr1,0,instr(addr1, ' ',1 ,1)) as addr1
		  from users
		 where substr(addr1,0,instr(addr1, ' ',1 ,1)) is not null
		   and user_id in (select user_id
		                     from personal_connection
		                    where (user_id =#{user_id} or receive_id =#{user_id})
		                      and receive_accept='Y'
		                      and user_id !=#{user_id}
		                    union
		                   select receive_id
		                     from personal_connection
		                    where (user_id =#{user_id} or receive_id =#{user_id})
		                      and receive_accept='Y'
		                      and receive_id !=#{user_id})
		 group by substr(addr1,0,instr(addr1, ' ',1 ,1))
	</select>
	
	
	<!-- 필터로 검색 - 전 직장 검색 -->
	<select id="filterSearchPastCorpor" parameterType="String" resultType="career_infoVo">
		select corporate_name
		  from career_info
		 where resign_date is not null
		   and user_id in (select user_id                     
		                     from personal_connection
		                    where (user_id =#{user_id} or receive_id =#{user_id})
		                      and receive_accept='Y'
		                      and user_id !=#{user_id}
		                    union
		                   select receive_id
		                     from personal_connection
		                    where (user_id =#{user_id} or receive_id =#{user_id})
		                      and receive_accept='Y'
		                      and receive_id !=#{user_id})
		 group by corporate_name
	</select>
	
	
	<!-- 필터로 검색 - 현 직장 검색 -->
	<select id="filterSearchPresentCorpor" parameterType="String" resultType="career_infoVo">
		select corporate_name
		  from career_info
		 where resign_date is null
		   and user_id in (select user_id                     
		                     from personal_connection
		                    where (user_id =#{user_id} or receive_id =#{user_id})
		                      and receive_accept='Y'
		                      and user_id !=#{user_id}
		                    union
		                   select receive_id
		                     from personal_connection
		                    where (user_id =#{user_id} or receive_id =#{user_id})
		                      and receive_accept='Y'
		                      and receive_id !=#{user_id})
		 group by corporate_name
	</select>
	
	
	<!-- 필터로 검색 - 직군 검색 -->
	<select id="filtersearchjobPosition" parameterType="String" resultType="career_infoVo">
		select job_position
		  from career_info
		 where user_id in (select user_id                     
		                     from personal_connection
		                    where (user_id =#{user_id} or receive_id =#{user_id})
		                      and receive_accept='Y'
		                      and user_id !=#{user_id}
		                    union
		                   select receive_id
		                     from personal_connection
		                    where (user_id =#{user_id} or receive_id =#{user_id})
		                      and receive_accept='Y'
		                      and receive_id !=#{user_id})
		 group by job_position
	</select>
	
	
	<!-- 필터로 검색 - 학교 검색 -->
	<select id="filterSearchSchool" parameterType="String" resultType="education_infoVo">
		select school_name
		  from education_info
		 where user_id in  (select user_id                     
		                      from personal_connection
		                     where (user_id =#{user_id} or receive_id =#{user_id})
		                       and receive_accept='Y'
		                       and user_id !=#{user_id}
		                     union
		                    select receive_id
		                      from personal_connection
		                     where (user_id =#{user_id} or receive_id =#{user_id})
		                       and receive_accept='Y'
		                       and receive_id !=#{user_id})
		 group by school_name
	</select>


	<!-- <select id="peopleSearch" parameterMap="java.util.Map" resultType="usersVo">
		 select a.user_id,
	           users.profile_path,
	           users.user_name,
	           users.profile_img,
	           b.introduce
		  from users ,( select distinct(b.user_id)
                          from (select user_id
                                  from personal_connection
                                 where (user_id =#{user_id} or receive_id ='#{user_id})
                                   and receive_accept='Y'
                                   and user_id !=#{user_id}
                                 union
                                select receive_id
                                  from personal_connection
                                 where (user_id =#{user_id} or receive_id =#{user_id})
                                   and receive_accept='Y'
                                   and receive_id !=#{user_id})a ,users b, CAREER_INFO c, EDUCATION_INFO d
                         where a.user_id = b.user_id
                           and b.user_id = c.user_id(+)
                           and c.user_id = d.user_id(+)
                           <if test="localList != null">
                           and 
	                           <foreach collection="localList" item="type"  open="and (" separator=")">
	                           		b.addr1 like '서울%'	
	 						   </foreach>
						   </if>
						   
                           
                            
						  
                          ) a , (select user_id,   
                                                                                               substr(listagg(beintroduce, ' ') within group (order by graduation desc), 0, instr(listagg(beintroduce, ' ') within group (order by graduation desc), ' ', 1, 2)) as introduce
                                                                                                   
                                                                                          from (select a.user_id,
                                                                                                  case when b.resign_date is null then b.corporate_name ||' ' ||job_position || ' '
                                                                                                       when b.resign_date is not null then a.school_name ||' ' || a.degree_name || ' '
                                                                                                   end as beintroduce,
                                                                                                       a.graduation
                                                                                                  from education_info a, career_info b
                                                                                                 where a.user_id = b.user_id
                                                                                                   and (b.user_id,nvl(b.resign_date,to_date('3000/01/01','yyyy/mm/dd'))) in ( select career_info.user_id,  max(nvl(career_info.resign_date,to_date('3000/01/01','yyyy/mm/dd')))
                                                                                                                                                                                from career_info, education_info
                                                                                                                                                                               where career_info.user_id = education_info.user_id
                                                                                                                                                                               group by career_info.user_id)
                                                                                                 order by a.graduation desc)
                                                                                         group by user_id ) b
		 where a.user_id = b.user_id(+)
		   and a.user_id = users.user_id(+);
		
	
	
	
	</select> -->
	
	<!-- 나와 상대방의 일촌 확인 -->
	<select id="select_oneConnections" parameterType="personalVo" resultType="personalVo">
		select receive_accept
		  from personal_connection
		 where (user_id = #{user_id} or receive_id = #{user_id}) 
		   and (receive_id = #{receive_id} or user_id = #{receive_id})
		   and receive_accept = 'Y'
	</select>
	
	<!-- 나와 상대방의 일촌 수락대기중 -->
	<select id="select_oneConnectionsWait" parameterType="personalVo" resultType="personalVo">
		select receive_accept
		  from personal_connection
		 where (user_id = #{user_id} or receive_id = #{user_id}) 
		   and (receive_id = #{receive_id} or user_id = #{receive_id})
		   and receive_accept = 'N'
	</select>
	
	<!-- 일촌 신청 -->
	<insert id="insert_connections" parameterType="personalVo">
		insert into personal_connection
			values(#{user_id},#{receive_id},'N')
	</insert>
	
	<!-- 일촌 삭제 -->
	<delete id="delete_connections" parameterType="personalVo">
		delete from personal_connection
		 where (user_id = #{user_id} or receive_id = #{user_id}) 
		   and (receive_id = #{receive_id} or user_id = #{receive_id})
		   and receive_accept = 'Y'
	</delete>
	
</mapper>