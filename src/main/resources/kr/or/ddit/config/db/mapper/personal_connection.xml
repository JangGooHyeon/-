<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="personal">


	<!-- 일촌 리스트 조회 -->
	<select id="select_connections" parameterType="memberVo" resultType="usersVo">
		select a.user_id,
	           users.profile_path,
	           users.user_name,
	           users.profile_img,
	           b.introduce
       
		  from users ,( select user_id
		                  from personal_connection
		                 where (user_id =#{mem_id} or receive_id =#{mem_id})
		                   and receive_accept='Y'
		                   and user_id !=#{mem_id}
		                 union
		                select receive_id
		                  from personal_connection
		                 where (user_id =#{mem_id} or receive_id =#{mem_id})
		                   and receive_accept='Y'
		                   and receive_id !=#{mem_id}) a , ( select distinct(a.user_id),
		                                                    case when b.resign_date is null then b.corporate_name || job_position
		                                                          when b.resign_date is not null then  a.school_name || a.degree_name
		                                                     end as introduce
		                                                    from EDUCATION_INFO a, CAREER_INFO b
		                                                   where a.user_id = b.user_id
		                                                     and (b.user_id,nvl(b.resign_date,to_date('3000/01/01','yyyy/mm/dd'))) in ( select CAREER_INFO.user_id,  max(nvl(CAREER_INFO.resign_date,to_date('3000/01/01','yyyy/mm/dd')))
		                                                                                                                                  from CAREER_INFO, EDUCATION_INFO
		                                                                                                                                 where CAREER_INFO.user_id = education_info.user_id
	                                                                                                                                 group by CAREER_INFO.user_id)) b
		 where a.user_id = b.user_id
		   and a.user_id = users.user_id
	</select>
	
	
	<!-- 팔로우한 일촌 수 조회 -->
	<select id="connections_count" parameterType="memberVo" resultType="int">
		select
			count(*)
		from
			personal_connection
		where
			(user_id=#{mem_id} or receive_id=#{mem_id})
		and
			receive_accept='Y'
	</select>
	
	
	<!-- 팔로우한 회사 수 조회 -->
	<select id="coporations_count" parameterType="followVo" resultType="int">
		select
			count(*)
		 from
		 	follow
		where
			division=#{division}
		  and
		  	mem_id=#{mem_id}
	</select>
	
	
	<!-- 팔로우한 회사 리스트 조회 -->
	<select id="select_followCoporation" parameterType="followVo" resultType="corporationVo">
		select
			b.*
  		from
  			follow a, corporation b
 		where
 			a.mem_id=#{mem_id}
   		and
   			a.division=#{division}
   		and
   			a.ref_keyword = b.corp_name
	</select>
	
	<!-- 팔로우한 일촌 리스트 조회 -->
	<select id="select_followConnections" parameterType="memberVo" resultType="usersVo">
		select a.user_id,
               users.profile_path,
               users.user_name,
               users.profile_img,
               b.introduce
          from users ,( select a.user_id
                          from (select user_id
                                  from personal_connection
                                 where (user_id =#{mem_id} or receive_id =#{mem_id})
                                   and receive_accept='Y'
                                   and user_id !=#{mem_id}
                                 union
                                select receive_id
                                  from personal_connection
                                 where (user_id =#{mem_id} or receive_id =#{mem_id})
                                   and receive_accept='Y'
                                   and receive_id !=#{mem_id}) a,(select FOLLOW_CODE,
                                                                         MEM_ID,
                                                                         REF_KEYWORD,
                                                                         DIVISION
                                                                    from FOLLOW
                                                                   where division='43' 
                                                                     and mem_id=#{mem_id})b 
                         where a.user_id = b.REF_KEYWORD) a , ( select distinct(a.user_id),
                                                                            case when b.resign_date is null then b.corporate_name || job_position
                                                                                 when b.resign_date is not null then a.school_name || a.degree_name
                                                                             end as introduce
                                                                            from EDUCATION_INFO a, CAREER_INFO b
                                                                           where a.user_id = b.user_id
                                                                             and (b.user_id,nvl(b.resign_date,to_date('3000/01/01','yyyy/mm/dd'))) in ( select CAREER_INFO.user_id,  max(nvl(CAREER_INFO.resign_date,to_date('3000/01/01','yyyy/mm/dd')))
                                                                                                                                                          from CAREER_INFO, EDUCATION_INFO
                                                                                                                                                         where CAREER_INFO.user_id = education_info.user_id
                                                                                                                                                      group by CAREER_INFO.user_id)) b
		 where a.user_id = b.user_id(+)
		   and a.user_id = users.user_id(+)
	</select>
	
	
	<!-- 팔로우한 해시태그 리스트 조회 -->
	<select id="select_followHashTag" parameterType="memberVo" resultType="followVo">
		select
			FOLLOW_CODE,
			MEM_ID,
			REF_KEYWORD,
			DIVISION
		from
			FOLLOW
		where
			division='16'
		and
			mem_id=#{mem_id}
	</select>
	
</mapper>